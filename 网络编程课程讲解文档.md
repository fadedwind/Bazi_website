# 八字排盘系统 - 网络编程课程讲解文档

## 📚 项目概述

这是一个基于 **Vue 3 + Node.js** 的八字排盘系统，采用 **HTTP REST API** 和 **WebSocket** 双协议通信架构，适合作为网络编程课程的实践项目。

## 🏗️ 系统架构

### 技术栈

**前端：**
- Vue 3 + uni-app
- WebSocket 客户端
- HTTP 请求封装

**后端：**
- Node.js + Express
- WebSocket 服务器 (ws 库)
- MySQL 数据库

### 通信架构图

```
┌─────────────────┐
│   前端 (Vue)    │
│                 │
│  ┌───────────┐  │
│  │ HTTP API  │  │  ←─── RESTful API
│  └───────────┘  │      (请求/响应模式)
│  ┌───────────┐  │
│  │ WebSocket │  │  ←─── 实时双向通信
│  └───────────┘  │      (推送/订阅模式)
└────────┬────────┘
         │
         │ 网络传输层
         │
┌────────▼────────┐
│  后端 (Node.js) │
│                 │
│  ┌───────────┐  │
│  │ Express   │  │  HTTP 服务器
│  └───────────┘  │
│  ┌───────────┐  │
│  │ WebSocket │  │  WebSocket 服务器
│  │  Server   │  │
│  └───────────┘  │
│  ┌───────────┐  │
│  │  MySQL    │  │  数据持久化
│  └───────────┘  │
└─────────────────┘
```

## 🔌 通信协议详解

### 1. HTTP REST API（请求/响应模式）

#### 特点
- **单向通信**：客户端发起请求，服务器响应
- **无状态**：每次请求独立，不保持连接
- **同步模式**：请求后等待响应

#### 使用场景
- 获取静态数据（提示信息、版本信息）
- 简单的查询操作
- 不需要实时性的操作

#### 代码示例

**前端请求：**
```javascript
// 8Char-Uni-App/src/api/default.js
export const GetInfo = data => Post('/8char/get-info', data, APP_API);
```

**后端处理：**
```javascript
// backend/src/routes/bazi.js
router.post('/get-info', async (req, res) => {
  // 处理请求
  res.json({ code: 200, data: result });
});
```

#### 讲解重点
1. **HTTP 协议基础**
   - 请求方法：GET、POST
   - 状态码：200、400、500
   - 请求头、响应头

2. **RESTful 设计**
   - 资源路径设计：`/api/8char/get-info`
   - 请求体格式：JSON
   - 响应格式统一

3. **异步处理**
   - Promise/async-await
   - 错误处理机制

---

### 2. WebSocket（实时双向通信）

#### 特点
- **双向通信**：客户端和服务器都可以主动发送消息
- **持久连接**：建立连接后保持打开状态
- **实时推送**：服务器可以主动推送数据给客户端
- **低延迟**：相比 HTTP 轮询更高效

#### 使用场景
- 实时计算进度推送
- 实时批命结果推送
- 在线用户统计
- 实时通知

#### 代码示例

**后端 WebSocket 服务器：**
```javascript
// backend/src/websocket/server.js
const WebSocket = require('ws');
const wss = new WebSocket.Server({ server, path: '/ws' });

wss.on('connection', (ws) => {
  // 处理连接
  ws.on('message', (message) => {
    // 处理消息
    ws.send(JSON.stringify(response));
  });
});
```

**前端 WebSocket 客户端：**
```javascript
// 8Char-Uni-App/src/utils/websocket.js
const ws = uni.connectSocket({ url: 'ws://localhost:3000/ws' });

ws.onMessage((res) => {
  const data = JSON.parse(res.data);
  // 处理接收到的消息
});

ws.send({ data: JSON.stringify(message) });
```

#### 讲解重点
1. **WebSocket 协议**
   - 握手过程（HTTP Upgrade）
   - 帧格式（Frame）
   - 心跳机制（Ping/Pong）

2. **连接管理**
   - 连接建立
   - 连接保持
   - 连接断开和重连

3. **消息格式**
   - JSON 消息格式
   - 消息类型设计
   - 错误处理

4. **实际应用**
   - 实时进度推送
   - 多客户端广播
   - 客户端管理

---

## 📖 课程讲解大纲

### 第一部分：HTTP REST API（30分钟）

#### 1. HTTP 协议基础（10分钟）
- HTTP 请求/响应模型
- 请求方法（GET、POST）
- 状态码含义
- 请求头和响应头

**演示：**
- 使用浏览器开发者工具查看 HTTP 请求
- 分析请求和响应的结构

#### 2. RESTful API 设计（10分钟）
- REST 架构原则
- 资源路径设计
- 请求体格式（JSON）
- 统一响应格式

**代码讲解：**
```javascript
// 查看 backend/src/routes/bazi.js
// 查看 8Char-Uni-App/src/api/default.js
```

#### 3. 异步编程（10分钟）
- Promise 和 async/await
- 错误处理
- 请求封装

**实践：**
- 修改 API 调用，添加错误处理
- 实现请求重试机制

---

### 第二部分：WebSocket 实时通信（40分钟）

#### 1. WebSocket 协议原理（15分钟）
- WebSocket vs HTTP
- 握手过程（HTTP Upgrade）
- 帧格式
- 心跳机制

**演示：**
- 使用 Wireshark 或浏览器工具查看 WebSocket 握手
- 分析 WebSocket 帧结构

#### 2. WebSocket 服务器实现（15分钟）
- 服务器端代码结构
- 连接管理
- 消息处理
- 心跳检测

**代码讲解：**
```javascript
// 查看 backend/src/websocket/server.js
```

**关键点：**
- 客户端连接管理（Map 存储）
- 消息路由（根据 type 分发）
- 心跳检测机制
- 错误处理和重连

#### 3. WebSocket 客户端实现（10分钟）
- 客户端连接
- 消息发送和接收
- 事件监听机制
- 自动重连

**代码讲解：**
```javascript
// 查看 8Char-Uni-App/src/utils/websocket.js
```

**实践：**
- 实现实时进度显示
- 实现多客户端消息广播

---

### 第三部分：实际应用场景（20分钟）

#### 1. 八字计算实时进度推送

**场景描述：**
- 用户提交八字计算请求
- 服务器分阶段计算
- 实时推送计算进度（0% → 100%）
- 最终返回计算结果

**实现流程：**
```
客户端发送请求 → WebSocket 连接
    ↓
服务器接收请求 → 开始计算
    ↓
服务器推送进度 (20%, 40%, 60%, 80%, 95%)
    ↓
服务器推送最终结果 (100%)
    ↓
客户端显示结果
```

**代码位置：**
- 后端：`backend/src/websocket/server.js` → `handleBaziCalculation()`
- 前端：`8Char-Uni-App/src/api/websocket.js` → `calculateBaziWithWS()`

#### 2. 多客户端连接管理

**演示：**
- 打开多个浏览器标签页
- 观察服务器端的连接管理
- 实现消息广播功能

---

## 🎯 讲解重点和难点

### 重点内容

1. **HTTP vs WebSocket 的区别**
   - 通信模式：单向 vs 双向
   - 连接方式：无状态 vs 持久连接
   - 使用场景：何时用 HTTP，何时用 WebSocket

2. **WebSocket 的实际应用**
   - 实时进度推送
   - 在线用户统计
   - 实时通知系统

3. **网络编程实践**
   - 错误处理
   - 连接管理
   - 消息格式设计

### 难点解析

1. **异步编程**
   - Promise 链式调用
   - async/await 语法
   - 错误传播机制

2. **WebSocket 连接管理**
   - 客户端 ID 生成
   - 连接状态维护
   - 心跳检测机制

3. **消息路由**
   - 根据消息类型分发处理
   - 事件监听机制
   - 回调函数设计

---

## 🛠️ 实践练习

### 练习 1：HTTP API 调用
- 修改前端代码，添加请求重试机制
- 实现请求缓存功能
- 添加请求日志记录

### 练习 2：WebSocket 实时通信
- 实现多客户端消息广播
- 添加在线用户列表功能
- 实现消息历史记录

### 练习 3：混合使用
- 使用 HTTP 获取初始数据
- 使用 WebSocket 接收实时更新
- 实现断线重连机制

---

## 📊 性能优化建议

1. **HTTP 优化**
   - 请求合并
   - 响应缓存
   - 压缩传输

2. **WebSocket 优化**
   - 消息压缩
   - 心跳间隔优化
   - 连接池管理

---

## 🔍 调试技巧

1. **HTTP 调试**
   - 浏览器开发者工具 Network 面板
   - Postman 测试工具
   - 服务器日志查看

2. **WebSocket 调试**
   - 浏览器开发者工具 WebSocket 面板
   - 服务器端日志输出
   - 消息格式验证

---

## 📝 总结

### 关键知识点

1. **HTTP REST API**
   - 请求/响应模式
   - 无状态通信
   - RESTful 设计原则

2. **WebSocket**
   - 双向实时通信
   - 持久连接
   - 心跳机制

3. **实际应用**
   - 根据场景选择合适的通信方式
   - 错误处理和重连机制
   - 性能优化

### 课程收获

- 理解 HTTP 和 WebSocket 的区别
- 掌握网络编程的基本技能
- 能够设计和实现实时通信系统
- 具备调试和优化网络应用的能力

---

## 📚 参考资料

- [MDN WebSocket API](https://developer.mozilla.org/zh-CN/docs/Web/API/WebSocket)
- [WebSocket RFC 6455](https://tools.ietf.org/html/rfc6455)
- [RESTful API 设计指南](https://restfulapi.net/)
- [Node.js WebSocket 库 ws](https://github.com/websockets/ws)

---

**项目地址：** https://github.com/fadedwind/Bazi_website

**最后更新：** 2025年


