# 虚拟主机部署指南

## 📋 准备工作

### 1. 获取虚拟主机信息

从虚拟主机控制面板获取以下信息：

- **数据库主机**：通常是 `localhost` 或 `127.0.0.1`
- **数据库端口**：通常是 `3306`（某些虚拟主机可能不需要）
- **数据库用户名**：虚拟主机提供的数据库用户名
- **数据库密码**：虚拟主机提供的数据库密码
- **数据库名称**：虚拟主机提供的数据库名称
- **FTP/SSH 信息**：用于上传文件

### 2. 创建数据库

在虚拟主机控制面板中：
1. 进入数据库管理
2. 创建新的 MySQL 数据库
3. 创建数据库用户并分配权限
4. 记录数据库连接信息

## 🔧 配置步骤

### 步骤 1：配置环境变量

在项目根目录的 `backend/` 文件夹中创建 `.env` 文件：

```env
# 数据库配置（使用虚拟主机提供的信息）
DB_HOST=localhost
DB_PORT=3306
DB_USER=your_database_user
DB_PASSWORD=your_database_password
DB_NAME=your_database_name

# 服务器配置
PORT=3000
NODE_ENV=production

# 前端地址（你的网站域名）
FRONTEND_URL=https://yourdomain.com
```

**注意：**
- 某些虚拟主机可能不需要 `DB_PORT`，可以删除这一行
- 如果虚拟主机不支持 `.env` 文件，可能需要：
  - 在控制面板中配置环境变量
  - 或直接修改 `backend/src/config/database.js` 文件（不推荐）

### 步骤 2：初始化数据库

#### 方式一：通过 SSH 连接（推荐）

如果虚拟主机支持 SSH：

```bash
# 连接到虚拟主机
ssh username@yourdomain.com

# 进入项目目录
cd /path/to/your/project/backend

# 运行初始化脚本
npm run init-db
```

#### 方式二：通过虚拟主机数据库管理面板

1. 登录虚拟主机控制面板
2. 进入数据库管理 → phpMyAdmin 或类似工具
3. 选择你的数据库
4. 执行以下 SQL 语句：

```sql
-- 创建查询记录表
CREATE TABLE IF NOT EXISTS `query_records` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `datetime` VARCHAR(50) NOT NULL COMMENT '出生时间',
  `gender` INT DEFAULT 1 COMMENT '性别：1-男，2-女',
  `sect` INT DEFAULT 0 COMMENT '流派：0-默认',
  `query_type` VARCHAR(50) DEFAULT 'get_info' COMMENT '查询类型',
  `ip` VARCHAR(50) DEFAULT '' COMMENT '客户端IP',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  INDEX `idx_created_at` (`created_at`),
  INDEX `idx_query_type` (`query_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='查询记录表';

-- 创建用户表（可选）
CREATE TABLE IF NOT EXISTS `users` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `username` VARCHAR(50) UNIQUE NOT NULL COMMENT '用户名',
  `email` VARCHAR(100) COMMENT '邮箱',
  `password` VARCHAR(255) COMMENT '密码（加密）',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX `idx_username` (`username`),
  INDEX `idx_email` (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';

-- 创建八字结果缓存表（可选）
CREATE TABLE IF NOT EXISTS `bazi_cache` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `datetime` VARCHAR(50) NOT NULL COMMENT '出生时间',
  `gender` INT DEFAULT 1 COMMENT '性别',
  `sect` INT DEFAULT 0 COMMENT '流派',
  `result` TEXT COMMENT '计算结果（JSON）',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `expires_at` TIMESTAMP NULL COMMENT '过期时间',
  UNIQUE KEY `uk_params` (`datetime`, `gender`, `sect`),
  INDEX `idx_expires_at` (`expires_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='八字结果缓存表';
```

### 步骤 3：上传文件

通过 FTP 或文件管理器上传项目文件：

```
yourdomain.com/
├── backend/          # 后端文件
│   ├── src/
│   ├── package.json
│   └── .env          # 配置文件（重要！）
└── 8Char-Uni-App/    # 前端文件
    └── dist/         # 前端构建后的文件
```

### 步骤 4：安装依赖

通过 SSH 连接虚拟主机：

```bash
cd /path/to/your/project/backend
npm install --production
```

### 步骤 5：配置 Node.js 应用

虚拟主机通常需要配置 Node.js 应用：

1. **PM2 进程管理**（如果支持）：
   ```bash
   npm install -g pm2
   pm2 start src/index.js --name bazi-backend
   pm2 save
   pm2 startup
   ```

2. **使用虚拟主机提供的 Node.js 管理器**：
   - 在控制面板中找到 Node.js 应用管理
   - 设置启动文件：`backend/src/index.js`
   - 设置启动命令：`node src/index.js`
   - 设置工作目录：`backend/`

3. **使用 systemd 服务**（如果支持）：
   创建 `/etc/systemd/system/bazi-backend.service`：
   ```ini
   [Unit]
   Description=Bazi Backend Service
   After=network.target

   [Service]
   Type=simple
   User=your_user
   WorkingDirectory=/path/to/your/project/backend
   ExecStart=/usr/bin/node src/index.js
   Restart=on-failure

   [Install]
   WantedBy=multi-user.target
   ```

   然后：
   ```bash
   sudo systemctl daemon-reload
   sudo systemctl enable bazi-backend
   sudo systemctl start bazi-backend
   ```

### 步骤 6：配置反向代理（如果需要）

如果虚拟主机使用 Nginx，需要配置反向代理：

```nginx
server {
    listen 80;
    server_name yourdomain.com;

    # 前端静态文件
    location / {
        root /path/to/your/project/8Char-Uni-App/dist;
        try_files $uri $uri/ /index.html;
    }

    # 后端 API
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # WebSocket
    location /ws {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 步骤 7：配置前端环境变量

在 `8Char-Uni-App` 目录创建 `.env.production`：

```env
VITE_API_URL=https://yourdomain.com
VITE_WS_URL=wss://yourdomain.com/ws
```

然后构建前端：

```bash
cd 8Char-Uni-App
npm install
npm run build:h5
```

## 🔍 常见问题

### 1. 数据库连接失败

**问题：** `❌ 数据库连接失败`

**解决方案：**
- 检查 `.env` 文件中的数据库配置是否正确
- 确认数据库用户有足够的权限
- 某些虚拟主机可能需要使用 `127.0.0.1` 而不是 `localhost`
- 检查数据库是否已创建

### 2. 端口被占用

**问题：** 端口 3000 已被使用

**解决方案：**
- 修改 `.env` 文件中的 `PORT` 值
- 或使用虚拟主机提供的端口

### 3. WebSocket 连接失败

**问题：** WebSocket 无法连接

**解决方案：**
- 检查防火墙设置
- 确认反向代理配置正确
- 某些虚拟主机可能需要使用 `wss://`（SSL）而不是 `ws://`
- 检查 WebSocket 路径是否正确（`/ws`）

### 4. 环境变量不生效

**问题：** `.env` 文件配置不生效

**解决方案：**
- 某些虚拟主机不支持 `.env` 文件
- 在控制面板中配置环境变量
- 或直接修改配置文件（不推荐）

### 5. Node.js 版本不兼容

**问题：** 需要特定版本的 Node.js

**解决方案：**
- 在虚拟主机控制面板中设置 Node.js 版本
- 建议使用 Node.js 16+ 版本

## 📝 检查清单

部署前请确认：

- [ ] 数据库已创建并配置正确
- [ ] `.env` 文件已创建并填写正确信息
- [ ] 数据库表已初始化
- [ ] 依赖已安装（`npm install`）
- [ ] 服务器已启动
- [ ] 端口配置正确
- [ ] 防火墙规则已配置
- [ ] 反向代理已配置（如需要）
- [ ] 前端已构建并上传
- [ ] 前端环境变量已配置
- [ ] 测试 API 接口是否正常
- [ ] 测试 WebSocket 连接是否正常

## 🚀 测试

部署完成后，测试以下内容：

1. **健康检查**：
   ```
   https://yourdomain.com/health
   ```

2. **API 测试**：
   ```
   https://yourdomain.com/api/8char/get-tips
   ```

3. **WebSocket 测试**：
   使用浏览器控制台或 WebSocket 测试工具连接：
   ```
   wss://yourdomain.com/ws
   ```

## 📞 获取帮助

如果遇到问题：

1. 查看服务器日志
2. 检查虚拟主机文档
3. 联系虚拟主机技术支持
4. 查看项目 README 文档

---

**最后更新：** 2025年



