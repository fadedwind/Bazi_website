# å®Œæ•´éƒ¨ç½²æŒ‡å—

## ðŸ“‹ ç›®å½•

1. [éƒ¨ç½²æ–¹æ¡ˆé€‰æ‹©](#éƒ¨ç½²æ–¹æ¡ˆé€‰æ‹©)
2. [å®å¡”é¢æ¿éƒ¨ç½²ï¼ˆæŽ¨èï¼‰](#å®å¡”é¢æ¿éƒ¨ç½²æŽ¨è)
3. [çŽ¯å¢ƒå˜é‡é…ç½®](#çŽ¯å¢ƒå˜é‡é…ç½®)
4. [Nginx é…ç½®](#nginx-é…ç½®)
5. [æ•°æ®åº“é…ç½®](#æ•°æ®åº“é…ç½®)
6. [å¸¸è§é—®é¢˜æŽ’æŸ¥](#å¸¸è§é—®é¢˜æŽ’æŸ¥)

---

## éƒ¨ç½²æ–¹æ¡ˆé€‰æ‹©

### æ–¹æ¡ˆä¸€ï¼šå‰ç«¯åœ¨å½©è™¹äº‘ + åŽç«¯åœ¨å®å¡”ï¼ˆè·¨åŸŸæ–¹æ¡ˆï¼‰

**ä¼˜ç‚¹ï¼š**
- âœ… å‰ç«¯å’ŒåŽç«¯åˆ†ç¦»ï¼Œä¾¿äºŽç‹¬ç«‹ç®¡ç†
- âœ… å‰ç«¯å¯ä»¥ä½¿ç”¨ CDN åŠ é€Ÿ

**ç¼ºç‚¹ï¼š**
- âŒ éœ€è¦é…ç½® CORS è·¨åŸŸ
- âŒ WebSocket è·¨åŸŸå¯èƒ½æœ‰é—®é¢˜
- âŒ éœ€è¦ç»´æŠ¤ä¸¤ä¸ªæœåŠ¡å™¨

### æ–¹æ¡ˆäºŒï¼šå‰ç«¯å’ŒåŽç«¯éƒ½åœ¨å®å¡”ï¼ˆåŒåŸŸæ–¹æ¡ˆï¼‰â­ **æŽ¨è**

**ä¼˜ç‚¹ï¼š**
- âœ… **æ— éœ€è·¨åŸŸé…ç½®**ï¼Œæœ€ç®€å•
- âœ… **WebSocket è¿žæŽ¥ç¨³å®š**ï¼ˆåŒåŸŸï¼‰
- âœ… **ç»Ÿä¸€ç®¡ç†**ï¼Œä¸€ä¸ªæœåŠ¡å™¨æžå®š
- âœ… **æ€§èƒ½æ›´å¥½**ï¼ˆå†…ç½‘é€šä¿¡ï¼‰

**æŽ¨èåŽŸå› ï¼š**
1. åŽç«¯å·²ç»åœ¨å®å¡”è¿è¡ŒæˆåŠŸ
2. å®å¡”æ”¯æŒé™æ€æ–‡ä»¶æ‰˜ç®¡ï¼Œéƒ¨ç½²å‰ç«¯å¾ˆç®€å•
3. åŒåŸŸè®¿é—®ï¼Œæ— éœ€å¤„ç†è·¨åŸŸé—®é¢˜
4. WebSocket è¿žæŽ¥æ›´ç¨³å®š

---

## å®å¡”é¢æ¿éƒ¨ç½²ï¼ˆæŽ¨èï¼‰

### ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºå‰ç«¯ç«™ç‚¹

1. **ç™»å½•å®å¡”é¢æ¿** â†’ **ç½‘ç«™** â†’ **æ·»åŠ ç«™ç‚¹**
2. **å¡«å†™ä¿¡æ¯**ï¼š
   - **åŸŸå**ï¼šä½ çš„å‰ç«¯åŸŸåï¼ˆå¦‚ï¼š`www.bazi.website`ï¼‰
   - **æ ¹ç›®å½•**ï¼š`/www/wwwroot/bazi-frontend`
   - **PHPç‰ˆæœ¬**ï¼šçº¯é™æ€ï¼ˆä¸éœ€è¦ PHPï¼‰
3. **ç‚¹å‡»ã€Œæäº¤ã€**

### ç¬¬äºŒæ­¥ï¼šä¸Šä¼ å‰ç«¯æ–‡ä»¶

1. **æœ¬åœ°æž„å»ºå‰ç«¯**ï¼š
   ```bash
   cd 8Char-Uni-App
   npm run build:h5
   ```

2. **ä¸Šä¼ æž„å»ºæ–‡ä»¶**ï¼š
   - å°† `8Char-Uni-App/dist/build/h5/` ç›®å½•ä¸‹çš„**æ‰€æœ‰æ–‡ä»¶**ä¸Šä¼ åˆ° `/www/wwwroot/bazi-frontend`
   - ç¡®ä¿ `index.html` åœ¨æ ¹ç›®å½•

3. **è®¾ç½®æ–‡ä»¶æƒé™**ï¼š
   ```bash
   chown -R www:www /www/wwwroot/bazi-frontend
   chmod -R 755 /www/wwwroot/bazi-frontend
   ```

### ç¬¬ä¸‰æ­¥ï¼šä¸Šä¼ åŽç«¯æ–‡ä»¶

1. **ä¸Šä¼ åŽç«¯æ–‡ä»¶**åˆ° `/www/wwwroot/backend`
2. **å®‰è£…ä¾èµ–**ï¼š
   ```bash
   cd /www/wwwroot/backend
   npm install --production
   ```

---

## çŽ¯å¢ƒå˜é‡é…ç½®

### åŽç«¯çŽ¯å¢ƒå˜é‡ï¼ˆ`.env`ï¼‰

åœ¨ `/www/wwwroot/backend/.env` æ–‡ä»¶ä¸­é…ç½®ï¼š

```env
# æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_PORT=3306
DB_USER=ä½ çš„æ•°æ®åº“ç”¨æˆ·å
DB_PASSWORD=ä½ çš„æ•°æ®åº“å¯†ç 
DB_NAME=bazi_db

# æœåŠ¡å™¨é…ç½®
PORT=3000
NODE_ENV=production

# å‰ç«¯åœ°å€ï¼ˆCORSï¼‰
FRONTEND_URL=https://www.bazi.website

# DeepSeek API å¯†é’¥ï¼ˆAI åŠŸèƒ½éœ€è¦ï¼‰
DEEPSEEK_API_KEY=ä½ çš„deepseek_api_key
```

**åˆ›å»ºæ–¹æ³•**ï¼ˆå®å¡”é¢æ¿ï¼‰ï¼š
1. **æ–‡ä»¶ç®¡ç†å™¨** â†’ è¿›å…¥ `/www/wwwroot/backend`
2. **æ˜¾ç¤ºéšè—æ–‡ä»¶**ï¼ˆå³ä¸Šè§’çœ¼ç›å›¾æ ‡ï¼‰
3. **æ–°å»ºæ–‡ä»¶** â†’ å‘½åä¸º `.env`
4. **ç¼–è¾‘æ–‡ä»¶**ï¼Œç²˜è´´ä¸Šé¢çš„å†…å®¹å¹¶ä¿®æ”¹
5. **ä¿å­˜**

**æˆ–ä½¿ç”¨ç»ˆç«¯**ï¼š
```bash
cd /www/wwwroot/backend
cat > .env << 'EOF'
DB_HOST=localhost
DB_PORT=3306
DB_USER=ä½ çš„æ•°æ®åº“ç”¨æˆ·å
DB_PASSWORD=ä½ çš„æ•°æ®åº“å¯†ç 
DB_NAME=bazi_db
PORT=3000
NODE_ENV=production
FRONTEND_URL=https://www.bazi.website
DEEPSEEK_API_KEY=ä½ çš„deepseek_api_key
EOF
```

### å‰ç«¯çŽ¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼‰

å¦‚æžœå‰ç«¯å’ŒåŽç«¯åœ¨**åŒä¸€ä¸ªåŸŸå**ä¸‹ï¼Œ**ä¸éœ€è¦é…ç½®**çŽ¯å¢ƒå˜é‡ï¼Œä»£ç ä¼šè‡ªåŠ¨ä½¿ç”¨å½“å‰åŸŸåã€‚

å¦‚æžœéœ€è¦é…ç½®ï¼Œåœ¨ `8Char-Uni-App/.env.production` æ–‡ä»¶ä¸­ï¼š

```env
# åŒåŸŸéƒ¨ç½²ï¼ˆæŽ¨èï¼‰
VITE_API_URL=https://www.bazi.website
VITE_WS_URL=wss://www.bazi.website/ws
```

---

## Nginx é…ç½®

### åœ¨å®å¡”é¢æ¿é…ç½®

1. **è¿›å…¥ç«™ç‚¹è®¾ç½®**ï¼šç½‘ç«™ â†’ ä½ çš„å‰ç«¯ç«™ç‚¹ â†’ **è®¾ç½®** â†’ **é…ç½®æ–‡ä»¶**
2. **åœ¨ `server { }` å—å†…æ·»åŠ ä»¥ä¸‹é…ç½®**ï¼š

```nginx
# å‰ç«¯é™æ€æ–‡ä»¶
location / {
    root /www/wwwroot/bazi-frontend;
    index index.html;
    try_files $uri $uri/ /index.html;
}

# API åå‘ä»£ç†
location /api/ {
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # è¶…æ—¶è®¾ç½®
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}

# WebSocket ä»£ç†
location /ws {
    proxy_pass http://127.0.0.1:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    
    # WebSocket è¶…æ—¶è®¾ç½®
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
}
```

3. **ä¿å­˜**å¹¶**é‡è½½é…ç½®**

**é‡è¦æç¤ºï¼š**
- âš ï¸ `location /api/` æœ«å°¾çš„æ–œæ  `/` **å¾ˆé‡è¦**
- âš ï¸ ç¡®ä¿åŽç«¯è¿è¡Œåœ¨ `http://127.0.0.1:3000`

---

## æ•°æ®åº“é…ç½®

### 1. åˆ›å»ºæ•°æ®åº“

1. **å®å¡”é¢æ¿** â†’ **æ•°æ®åº“** â†’ **æ·»åŠ æ•°æ®åº“**
2. **å¡«å†™ä¿¡æ¯**ï¼š
   - **æ•°æ®åº“å**ï¼š`bazi_db`
   - **ç”¨æˆ·å**ï¼šè‡ªå®šä¹‰
   - **å¯†ç **ï¼šè‡ªå®šä¹‰
3. **ç‚¹å‡»ã€Œæäº¤ã€**

### 2. åˆå§‹åŒ–æ•°æ®åº“è¡¨

```bash
cd /www/wwwroot/backend
npm run init-db
```

### 3. æ›´æ–° `.env` æ–‡ä»¶

ç¡®ä¿ `.env` æ–‡ä»¶ä¸­çš„æ•°æ®åº“é…ç½®æ­£ç¡®ã€‚

---

## å¸¸è§é—®é¢˜æŽ’æŸ¥

### é—®é¢˜1ï¼šå‰ç«¯é¡µé¢æ˜¾ç¤º 404

**è§£å†³ï¼š**
- æ£€æŸ¥ `root` è·¯å¾„æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥å‰ç«¯æ–‡ä»¶æ˜¯å¦å·²ä¸Šä¼ 
- æ£€æŸ¥ `index.html` æ˜¯å¦åœ¨æ ¹ç›®å½•

### é—®é¢˜2ï¼šAPI è¯·æ±‚å¤±è´¥

**è§£å†³ï¼š**
- æ£€æŸ¥åŽç«¯æœåŠ¡æ˜¯å¦è¿è¡Œï¼š`ps aux | grep node`
- æ£€æŸ¥åŽç«¯ç«¯å£æ˜¯å¦ä¸º 3000
- æ£€æŸ¥ Nginx é…ç½®ä¸­çš„ `location /api/` æ˜¯å¦æ­£ç¡®
- æŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—ï¼š`tail -f /www/wwwlogs/ä½ çš„ç«™ç‚¹-error.log`

### é—®é¢˜3ï¼šWebSocket è¿žæŽ¥å¤±è´¥

**è§£å†³ï¼š**
- æ£€æŸ¥ `location /ws` é…ç½®æ˜¯å¦æ­£ç¡®
- ç¡®ä¿ `proxy_http_version 1.1;` å’Œ `Upgrade`ã€`Connection` å¤´å·²è®¾ç½®
- å¦‚æžœä½¿ç”¨ HTTPSï¼Œç¡®ä¿ä½¿ç”¨ `wss://`ï¼ˆå‰ç«¯ä¼šè‡ªåŠ¨å¤„ç†ï¼‰

### é—®é¢˜4ï¼šæ•°æ®åº“è¿žæŽ¥å¤±è´¥

**è§£å†³ï¼š**
- æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„æ•°æ®åº“é…ç½®æ˜¯å¦æ­£ç¡®
- ç¡®è®¤æ•°æ®åº“ç”¨æˆ·æœ‰è¶³å¤Ÿçš„æƒé™
- æŸäº›è™šæ‹Ÿä¸»æœºå¯èƒ½éœ€è¦ä½¿ç”¨ `127.0.0.1` è€Œä¸æ˜¯ `localhost`
- æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å·²åˆ›å»º

### é—®é¢˜5ï¼šAI åŠŸèƒ½ä¸å¯ç”¨

**è§£å†³ï¼š**
- æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­æ˜¯å¦é…ç½®äº† `DEEPSEEK_API_KEY`
- é‡å¯åŽç«¯æœåŠ¡
- æŸ¥çœ‹åŽç«¯æ—¥å¿—ç¡®è®¤ AI æœåŠ¡æ˜¯å¦åˆå§‹åŒ–æˆåŠŸ

### é—®é¢˜6ï¼šæ¨¡å—æœªæ‰¾åˆ°é”™è¯¯

**è§£å†³ï¼š**
```bash
cd /www/wwwroot/backend
rm -rf node_modules package-lock.json
npm cache clean --force
npm install --production
```

---

## å¯åŠ¨æœåŠ¡

### å¼€å‘çŽ¯å¢ƒ

```bash
# åŽç«¯
cd backend
npm run dev

# å‰ç«¯ï¼ˆæ–°ç»ˆç«¯ï¼‰
cd 8Char-Uni-App
npm run dev:h5
```

### ç”Ÿäº§çŽ¯å¢ƒ

#### æ–¹æ³•ä¸€ï¼šç›´æŽ¥å¯åŠ¨

```bash
cd /www/wwwroot/backend
npm start
```

#### æ–¹æ³•äºŒï¼šä½¿ç”¨ PM2ï¼ˆæŽ¨èï¼‰

```bash
# å®‰è£… PM2ï¼ˆå¦‚æžœæœªå®‰è£…ï¼‰
npm install -g pm2

# å¯åŠ¨æœåŠ¡
cd /www/wwwroot/backend
pm2 start src/index.js --name bazi-backend

# ä¿å­˜é…ç½®
pm2 save

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
```

**PM2 å¸¸ç”¨å‘½ä»¤**ï¼š
```bash
pm2 list              # æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹
pm2 logs bazi-backend # æŸ¥çœ‹æ—¥å¿—
pm2 restart bazi-backend  # é‡å¯æœåŠ¡
pm2 stop bazi-backend     # åœæ­¢æœåŠ¡
pm2 delete bazi-backend   # åˆ é™¤æœåŠ¡
```

### å¼€å‘æ¨¡å¼ vs ç”Ÿäº§æ¨¡å¼

**ç”Ÿäº§æ¨¡å¼**ï¼ˆé»˜è®¤ï¼‰ï¼š
- ä½¿ç”¨ `npm install --production`ï¼Œåªå®‰è£…è¿è¡Œæ—¶ä¾èµ–
- ä½¿ç”¨ `npm start`ï¼ˆç›´æŽ¥è¿è¡Œ `node src/index.js`ï¼‰
- ä»£ç ä¿®æ”¹åŽéœ€è¦æ‰‹åŠ¨é‡å¯

**å¼€å‘æ¨¡å¼**ï¼ˆéœ€è¦è°ƒè¯•æ—¶ï¼‰ï¼š
- ä½¿ç”¨ `npm install`ï¼Œå®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬ `nodemon`ï¼‰
- ä½¿ç”¨ `npm run dev`ï¼ˆä½¿ç”¨ `nodemon` è‡ªåŠ¨é‡å¯ï¼‰
- ä»£ç ä¿®æ”¹åŽè‡ªåŠ¨é‡å¯

**åˆ‡æ¢æ–¹æ³•**ï¼š
```bash
cd /www/wwwroot/backend
rm -rf node_modules package-lock.json
npm install          # å¼€å‘æ¨¡å¼
# æˆ–
npm install --production  # ç”Ÿäº§æ¨¡å¼
```

---

## éªŒè¯éƒ¨ç½²

1. **è®¿é—®å‰ç«¯ç½‘ç«™**ï¼š`https://www.bazi.website`
2. **æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰â†’ Network æ ‡ç­¾**
3. **å°è¯•æŽ’ç›˜åŠŸèƒ½**ï¼ŒæŸ¥çœ‹ï¼š
   - API è¯·æ±‚åº”è¯¥åˆ° `/api/8char/get-info`
   - WebSocket åº”è¯¥è¿žæŽ¥åˆ° `wss://www.bazi.website/ws`
   - çŠ¶æ€ç åº”è¯¥æ˜¯ 200
4. **æ£€æŸ¥å®žæ—¶è¿›åº¦**ï¼šæŽ’ç›˜æ—¶åº”è¯¥çœ‹åˆ°è¿›åº¦æç¤º

---

## å¿«é€Ÿæ£€æŸ¥æ¸…å•

- [ ] å‰ç«¯æ–‡ä»¶å·²ä¸Šä¼ åˆ°å®å¡”
- [ ] åŽç«¯æ–‡ä»¶å·²ä¸Šä¼ å¹¶å®‰è£…ä¾èµ–
- [ ] `.env` æ–‡ä»¶å·²é…ç½®ï¼ˆæ•°æ®åº“ã€API å¯†é’¥ç­‰ï¼‰
- [ ] Nginx åå‘ä»£ç†å·²é…ç½®ï¼ˆ`/api/` å’Œ `/ws`ï¼‰
- [ ] æ•°æ®åº“å·²åˆ›å»ºå¹¶åˆå§‹åŒ–
- [ ] åŽç«¯æœåŠ¡å·²å¯åŠ¨
- [ ] å‰ç«¯ç½‘ç«™å¯ä»¥æ­£å¸¸è®¿é—®
- [ ] API è¯·æ±‚æˆåŠŸ
- [ ] WebSocket è¿žæŽ¥æˆåŠŸ

---

## ç›¸å…³æ–‡æ¡£

- [WebSocket ä½¿ç”¨è¯´æ˜Ž](./WebSocketä½¿ç”¨è¯´æ˜Ž.md)
- [é¡¹ç›®è¿è¡Œæ–¹æ³•](../8Char-Uni-App/ToRun.md)

